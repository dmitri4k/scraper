## Deadlock

Дедлок – состояние взаимной блокировки двух или более потоков. Такая ситуация возникает в том случае, 
когда первый поток ждёт освобождения ресурса, которым владеет второй поток, а второй поток ждёт освобождения ресурса, которым владеет первый. 
Понятно, что в таком состоянии могут находиться не только два потока, а несколько.

Как пример дедлока рассмотрим задачу обедающих философов. Эта задача была придумана Дейкстрой и сформулирована в современном виде Хоаром для 
описания типичных проблем многопоточной среды.

За круглым столом сидят философы (для определённости их пять), пронумерованные против часовой стрелки. На столе лежат 5 вилок. Каждый философ должен взять две вилки 
(левую от себя и правую от себя), пообедать и положить их обратно. Проблема в том, что философы берут вилки по очереди, поэтому 
после того, как один взял левую вилку, правая, к примеру, уже может находиться в руках второго философа. Тогда 
первый вынужден будет ждать, когда второй пообедает.

Пусть первый уже взял левую вилку. Второй, третий, четвёртый и пятый поступили также. Левая вилка у второго философа является правой у первого, поэтому первый не может взять правую. Философ будет бесконечно ожидать правую вилку, также будут ожидать и все остальные философы. Мы получим дедлок, в котором пять потоков взаимно ожидают разблокировки ресурсов. Очевидно, что из этой ситуации есть выход, и даже не один.
Для начала реализуем эту ситуацию, а потом найдём из неё какой-нибудь выход.

Объявим структуру «философ», которая будет хранить имя философа и номера вилок, которые он может взять.

Далее структура «стол», которая состоит их массива вилок. В качестве вилки будет выступать мьютекс. Блокировка мьютекса означает «взять вилку», а разблокировка «положить её обратно».

Кроме того, для передачи этих параметров в поток объединим их в структуру

Две вспомогательные функции инициализации

И наша основная функция, eat, которая моделирует обед

Теперь осталось самое малое – инициализировать 5 потоков и запустить их.

Запускаем, и… никакого дедлока нет. Дело в том, что запуск потока операция небыстрая. Поэтому первый запущенный философ успевает поесть и отдать вилки. Для эмуляции дедлока замедлим процесс подъёма вилки со стола: добавим sleep

Тепеь мы получили состояние, в котором пять потоков ждут разблокировки ресурсов.

Какое может быть решение? Рассмотрим самое простое. Наша проблема заключается в том, что «взять вилки» - это не атомарная операция. 
Она состоит из двух операций – «взять левую» и «взять правую». Для того, чтобы никто больше не мог брать вилки, пока один человек 
берёт вилки, добавим ещё один мьютекс, который будет блокировать взятие вилок:

А теперь весь код. Пусть философы едят бесконечно и ждут случайное время

![mail.png](../images/mail.png)

