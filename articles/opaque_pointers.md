## Opaque pointers и инкапсуляция в си.

Приведённый ниже материал не относится к основному курсу, но позволяет полнее понять особенности языка си и упростить решение некоторых прикладных задач. 
Если вы не смогли совладать с основным курсом, остановитесь здесь и не читайте дальше.

Инкапсуляция –  механизм, позволяющий скрыть свойства объекта от свободного изменения. Когда мы определяем структуру в си, поля структуры доступны всем через операцию точка или стрелка.
Очень часто существует необходимость защитить поля от доступа. Например, у нас есть структура, которая хранит имя, фамилию, идентификационный номер, пол и возраст человека.

Любая функция может беспрепятственно изменить поля структуры, причём задать значения, которые противоречат здравому смыслу. Конечно, всегда можно проверять данные при вводе, но, рано или поздно, вы либо забудете это сделать, либо ленивый программист не сделает проверку значений и получит ошибку.
Также часто нужно хранить скрытые параметры, которые нельзя изменять извне. Например, структура массив может иметь переменную размер, которая отвечает за текущее количество объектов в массиве. Изменяться она должна только тогда, когда добавляются новые элементы. Извне эта переменная может быть только считана, но её нельзя менять.
Стандартная структура не позволяет инкапсулировать данные. Однако особенность процесса компиляции помогает добиться нужных для нас свойств.

Создадим два файла: Box.h и Box.c В файле Box.h опишем структуру без полей и новый тип.

Структура Box_ не содержит полей. Поэтому при компиляции, когда мы подключим файл Box.h к нашему проекту, к полям структуры обратиться будет нельзя. В файле Box.c доопределим эту структуру:

Поля структуры Box_ теперь видны только в файле Box.c. Функции, описанные в Box.c будут видеть поля структуры и иметь доступ до них, в остальных файлах доступа до полей не будет. Так как функции определены по умолчанию как extern (если, конечно, они не определены явно как static), все функции будут доступны извне.
Таким образом, доступ до всех полей будет осуществляться через функции, которые уже будут проверять корректность введённых данных. Также функции смогут обращаться к тем полям, доступа до которых вообще не должно быть.

Содержимое Box.h теперь

Содержимое Box.c

Один момент – мы не проверяем правильность данных в функциях setHeight, setWidth  и setDepth. Функции проверки, между тем, должны быть, но они не должны быть видны вне нашего 
файла. То есть, функции должны быть также защищены, как и поля структуры, только не от изменения, а от использования. Это делается стандартным способом – определим новые 
функции как static:

В Box.h

В Box.c

Конечный результат работы
Box.h

Box.c

main.c

Этот трюк довольно часто используется при попытках создать ООП-подобные интерфейсы в си.

![mail.png](../images/mail.png)

